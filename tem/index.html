<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=lgzxer2wyq&submodules=geocoder"></script>
    <style>
      @font-face {
        font-family: 'NanumSquareRound';
        src: url('https://fastly.jsdelivr.net/gh/projectnoonnu/noonfonts_two@1.0/NanumSquareRound.woff') format('woff');
        font-weight: normal;
        font-style: normal;
      }

      html {
        background-color: darkolivegreen;
      }

      * {
        color: white;
        font-family: 'NanumSquareRound';
      }
      h1 {
        text-align: center;
      }
      #grid {
        display: grid;

        grid-template-rows: repeat(3, 1fr);
        grid-template-columns: repeat(2, 1fr);
      }

      .grid_c:first-child {
        grid-column: 1 / 3;
      }

      .grid_c {
        text-align: center;

        margin-bottom: 5vh;
      }
      
      #T1H {
        color: rgb(255, 80, 80);
      }
      #REH {
        color: rgb(80, 208, 255);
      }
      #RN1 {
        color: rgb(80, 141, 255);
      }
      #VEC, #WSD {
        color: rgb(80, 255, 232);
      }
    </style>
  </head>
  <body>
    <div>
      <div>
        <h1><span id="sido"></span> <span id="sigugun"></span> <span id="dongmyun"></span></h1>
        <div id="grid">
          <div class="grid_c">기온<br><span id="T1H"></span>℃</div>
          <div class="grid_c">습도<br><span id="REH"></span>%</div>
          <div class="grid_c">1시간 강수량<br><span id="RN1"></span>mm</div>
          <div class="grid_c">풍향<br><span id="VEC"></span>deg</div>
          <div class="grid_c">풍속<br><span id="WSD"></span>m/s</div>
        </div>
      </div>
    </div>
    <script>
      var RE = 6371.00877;
      var GRID = 5.0;
      var SLAT1 = 30.0;
      var SLAT2 = 60.0;
      var OLON = 126.0;
      var OLAT = 38.0;
      var XO = 43;
      var YO = 136;

      function dfs_xy_conv(code, v1, v2) {
        var DEGRAD = Math.PI / 180.0;
        var RADDEG = 180.0 / Math.PI;

        var re = RE / GRID;
        var slat1 = SLAT1 * DEGRAD;
        var slat2 = SLAT2 * DEGRAD;
        var olon = OLON * DEGRAD;
        var olat = OLAT * DEGRAD;

        var sn = Math.tan(Math.PI * 0.25 + slat2 * 0.5) / Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sn = Math.log(Math.cos(slat1) / Math.cos(slat2)) / Math.log(sn);
        var sf = Math.tan(Math.PI * 0.25 + slat1 * 0.5);
        sf = Math.pow(sf, sn) * Math.cos(slat1) / sn;
        var ro = Math.tan(Math.PI * 0.25 + olat * 0.5);
        ro = re * sf / Math.pow(ro, sn);
        var rs = {};
        if (code == "toXY") {
            rs['lat'] = v1;
            rs['lng'] = v2;
            var ra = Math.tan(Math.PI * 0.25 + (v1) * DEGRAD * 0.5);
            ra = re * sf / Math.pow(ra, sn);
            var theta = v2 * DEGRAD - olon;
            if (theta > Math.PI) theta -= 2.0 * Math.PI;
            if (theta < -Math.PI) theta += 2.0 * Math.PI;
            theta *= sn;
            rs['x'] = Math.floor(ra * Math.sin(theta) + XO + 0.5);
            rs['y'] = Math.floor(ro - ra * Math.cos(theta) + YO + 0.5);
        }
        else {
            rs['x'] = v1;
            rs['y'] = v2;
            var xn = v1 - XO;
            var yn = ro - v2 + YO;
            ra = Math.sqrt(xn * xn + yn * yn);
            if (sn < 0.0) - ra;
            var alat = Math.pow((re * sf / ra), (1.0 / sn));
            alat = 2.0 * Math.atan(alat) - Math.PI * 0.5;

            if (Math.abs(xn) <= 0.0) {
                theta = 0.0;
            }
            else {
                if (Math.abs(yn) <= 0.0) {
                    theta = Math.PI * 0.5;
                    if (xn < 0.0) - theta;
                }
                else theta = Math.atan2(xn, yn);
            }
            var alon = theta / sn + olon;
            rs['lat'] = alat * RADDEG;
            rs['lng'] = alon * RADDEG;
        }
        return rs;
      }

      var data = {
        REH: undefined,
        RN1: undefined,
        T1H: undefined,
        VEC: undefined,
        WSD: undefined
      }

      window.onload = () => {
        navigator.geolocation.getCurrentPosition((position) => {
          const x = dfs_xy_conv("toXY", position.coords.latitude, position.coords.longitude).x;
          const y = dfs_xy_conv("toXY", position.coords.latitude, position.coords.longitude).y;
  
          const year = new Date().getFullYear();
          const month = new Date().getMonth() + 1;
          const day = new Date().getDate();
          const hour = new Date().getHours();
          const min = new Date().getMinutes();
          
          fetch(window.location.origin + "/getData", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              x: x,
              y: y,
  
              year: year,
              month: month,
              day: day,
              hour: hour,
              min: min / 10
            })
          })
          .then((response) => response.json())
          .then((result) => {
            alret(result)
            result = JSON.parse(result)
            console.log(result.items.item)
            result.items.item.forEach(e => {
              data[e?.category] = e?.obsrValue
            });
            naver.maps.Service.reverseGeocode({
              location: new naver.maps.LatLng(dfs_xy_conv("toLL", x, y).lat, dfs_xy_conv("toLL", x, y).lng),
            }, function(status, response) {
              if (status !== naver.maps.Service.Status.OK) {
                return alert('Something wrong!');
              }

              var items = response.result.items[0].addrdetail;

              document.getElementById("sido").innerText = items.sido;
              document.getElementById("sigugun").innerText = items.sigugun;
              document.getElementById("dongmyun").innerText = items.dongmyun;
            });

            document.getElementById("T1H").innerText = data.T1H;
            document.getElementById("REH").innerText = data.REH;
            document.getElementById("RN1").innerText = data.RN1;
            document.getElementById("VEC").innerText = data.VEC;
            document.getElementById("WSD").innerText = data.WSD;
          })
        });
      }
    </script>
  </body>
</html>